/* angular-invocation-handler - Version 1.3.1, 26-08-2015
 * 
 * Enables general error handling and logging which allows to log errors, e.g for automatically sending back to the backend or for showing to the user
 * 
 * Copyright 2015  - Martin Reinhardt <contact@martinreinhardt-online.de>
 * License MIT
 */
var core=angular.module("ngIH.core",[]),ui=angular.module("ngIH.ui",[]);core.constant("ngIHConfig",{model:{alerts:"alerts"},httpErrors:{0:"Der Server ist nicht erreichbar..",404:"Dieser Dienst existiert nicht.",405:"Zugriffsfehler.",500:"Unbekannte Serverfehler."},httpTimeout:3e3,redirect:!1,customErrorHandler:!1,template:'<alert ng-repeat="alert in alerts" type="{{alert.type}}" close="alerts.splice($index, 1)">{{::alert.msg}}</alert>',feedbackAttach:!1}),core.provider("ngIHService",function(){"use strict";function a(a,b,c){return angular.extend(function(){var d=a.get("ngIHService");return d.call(c,b,arguments)},c)}function b(a){return!!(a&&a.constructor&&a.call&&a.apply)}var c=["$delegate","$injector",function(b,c){for(var d in b)angular.isFunction(b[d])&&(b[d]=a(c,b,b[d]));return b}];return{decorate:function(a,b){angular.forEach(b,function(b){a.decorator(b,c)})},$get:["$log","$injector","$window","$location","feedbackUI","ngIHConfig",function(a,c,d,e,f,g){var h={errors:[],resolveErrorCode:function(b,e,f){if(e){var h={error:{message:"An unknown error occurred.",data:e.data},timestamp:new Date,browserInfo:{navigatorAppName:navigator.appName,navigatorUserAgent:navigator.userAgent,navigatorPlatform:navigator.platform},location:angular.toJson(d.location),performance:d.performance?angular.toJson(d.performance):null};if(e&&!angular.isUndefined(e.status))h.status=e.status,g.customErrorHandler||(h.error.message=g.httpErrors[e.status0]);else if(e&&e.message){var i=e.message;h.error.exception=i.toString(),i.stack&&(h.error.stack=i.stack.toString())}b&&b.description&&(h.descripton="Call to "+b.description+" had caused errors."),a.error("An error occurred: "+JSON.stringify(h)),g.customErrorHandler?c.get(g.customErrorHandler).resolve(h,f):f(h)}},funcError:function(c,d,i){b(i[i.length-1])&&!b(i[i.length-2])&&h.resolveErrorCode(c,d,function(b){g.feedbackAttach&&f.appendErrorMsg(b),h.errors.push(b),g.redirect&&(a.info("Redirect to /"+d.status+".html"),e.path("/"+d.status+".html"))})},call:function(b,c,d){a.debug("Function called: ",b.name||b);var e;try{e=b.apply(c,d)}catch(f){throw h.funcError(b,f,d),f}var g=e&&e.$promise||e;return g&&angular.isFunction(g.then)&&angular.isFunction(g["catch"])&&h.async(b,g,d),e},async:function(a,b,c){return b["catch"](function(b){h.funcError(a,b,c)}),b}};return h}]}}),core.factory("httpErrorInterceptor",["ngIHConfig",function(a){"use strict";return{request:function(b){return b.timeout=a.httpTimeout,b}}}]),core.config(["$provide","$httpProvider",function(a,b){"use strict";b.interceptors.push("httpErrorInterceptor"),a.decorator("$exceptionHandler",["$delegate",function(a){return function(b,c){a(b,c)}}])}]),ui.factory("feedbackUI",["ngIHConfig","$timeout","$rootScope",function(a,b,c){"use strict";return{appendErrorMsg:function(b){c[a.model.alerts]||(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"danger",msg:b})},appendInfoMsg:function(b){c[a.model.alerts]||(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"info",msg:b})}}}]),ui.directive("uiErrorHandler",["$rootScope","ngIHConfig",function(a,b){"use strict";var c=function(a,c,d){b.scrollToError&&a.$watchCollection("val",function(a){$("body").animate({scrollTop:c.offset().top},"slow")})};return{restrict:"E",scope:{val:"="},compile:function(a){return a.append(b.template),c}}}]),ui.run(["$rootScope","$document","ngIHConfig","$templateCache",function(a,b,c,d){"use strict";if(a.$on("$routeChangeStart",function(){a[c.model.alerts]=[]}),c.feedbackAttach){var e='<ui-error-handler val="alerts"></ui-error-handler>',f=c.uiSelector||".navbar";b.find(f).length?angular.element(b.find(f)).append(e):angular.element(b.find("body")).prepend(e),c.template&&(c.templateUrl="$$angular-errorhandler-template$$",d.put(c.templateUrl,c.template))}}]);