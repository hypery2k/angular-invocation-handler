/* angular-invocation-handler - Version 1.4.4, 25-06-2016
 * 
 * Enables general error handling and logging which allows to log errors, e.g for automatically sending back to the backend or for showing to the user
 * 
 * Copyright 2016  - Martin Reinhardt <contact@martinreinhardt-online.de>
 * License MIT
 */
!function(a){"use strict";var b=a.module("ngIH.core",[]),c=a.module("ngIH.ui",[]);b.constant("ngIHConfig",{model:{alerts:"alerts"},httpErrors:{0:"Der Server ist nicht erreichbar..",404:"Dieser Dienst existiert nicht.",405:"Zugriffsfehler.",500:"Unbekannte Serverfehler."},httpTimeout:3e3,redirect:!1,customErrorHandler:!1,template:'<alert ng-repeat="alert in alerts" type="{{alert.type}}" close="alerts.splice($index, 1)">{{::alert.msg}}</alert>',feedbackAttach:!1}),b.provider("ngIHService",function(){function b(b,c,d){return a.extend(function(){var a=b.get("ngIHService");return a.call(d,c,arguments)},d)}function c(a){return!!(a&&a.constructor&&a.call&&a.apply)}function d(b,c){var d={error:{message:"An unknown error occurred.",data:b.data},timestamp:new Date,browserInfo:{navigatorAppName:navigator.appName,navigatorUserAgent:navigator.userAgent,navigatorPlatform:navigator.platform},location:a.toJson(c.location),performance:c.performance?a.toJson(c.performance):null};return d}function e(b,c,e,f){var g=d(b,c);if(b&&!a.isUndefined(b.status))g.status=b.status,e.customErrorHandler||(g.error.message=e.httpErrors[b.status0]);else if(b&&b.message){var h=b.message;g.error.exception=h.toString(),h.stack&&(g.error.stack=h.stack.toString())}return f&&f.description&&(g.descripton="Call to "+f.description+" had caused errors."),g}var f=["$delegate","$injector",function(c,d){for(var e in c)a.isFunction(c[e])&&(c[e]=b(d,c,c[e]));return c}];return{decorate:function(b,c){a.forEach(c,function(a){b.decorator(a,f)})},$get:["$log","$injector","$window","$location","feedbackUI","ngIHConfig",function(b,d,f,g,h,i){var j={errors:[],resolveErrorCode:function(a,c,g){if(c){var h=e(c,f,i,a);if(b.error("An error occurred: "+JSON.stringify(h)),!i.customErrorHandler)return g(h);d.get(i.customErrorHandler).resolve(h,g)}},funcError:function(a,d,e){var f=c(e[e.length-1])&&!c(e[e.length-2]);(!e||e&&f)&&j.resolveErrorCode(a,d,function(a){i.feedbackAttach&&h.appendErrorMsg(a),j.errors.push(a),i.redirect&&(b.info("Redirect to /"+d.status+".html"),g.path("/"+d.status+".html"))})},call:function(c,d,e){b.debug("Function called: ",c.name||c);var f;try{f=c.apply(d,e)}catch(g){throw j.funcError(c,g,e),g}var h=f&&f.$promise||f;return h&&a.isFunction(h.then)&&a.isFunction(h["catch"])&&j.async(c,h,e),f},async:function(a,b,c){return b["catch"](function(b){j.funcError(a,b,c)}),b}};return j}]}}),b.factory("httpErrorInterceptor",["ngIHConfig",function(a){return{request:function(b){return b.timeout=a.httpTimeout,b}}}]),b.config(["$provide","$httpProvider",function(a,b){b.interceptors.push("httpErrorInterceptor"),a.decorator("$exceptionHandler",["$delegate",function(a){return function(b,c){a(b,c)}}])}]),c.factory("feedbackUI",["ngIHConfig","$timeout","$rootScope",function(a,b,c){return{appendErrorMsg:function(b){(!c[a.model.alerts]||a.feedbackClear)&&(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"danger",msg:b})},appendInfoMsg:function(b){(!c[a.model.alerts]||a.feedbackClear)&&(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"info",msg:b})}}}]),c.directive("uiErrorHandler",["$rootScope","ngIHConfig",function(a,b){var c=function(a,c,d){b.scrollToError&&a.$watchCollection("val",function(a){$("body").animate({scrollTop:c.offset().top},"slow")})};return{restrict:"E",scope:{val:"="},compile:function(a){return a.append(b.template),c}}}]),c.run(["$rootScope","$document","$timeout","ngIHConfig","$templateCache",function(b,c,d,e,f){if(b.$on("$locationChangeSuccess",function(){d(function(){b[e.model.alerts]=[]})}),e.feedbackAttach){var g='<ui-error-handler val="alerts"></ui-error-handler>',h=e.uiSelector||".navbar";c.find(h).length?a.element(c.find(h)).append(g):a.element(c.find("body")).prepend(g),e.template&&(e.templateUrl="$$angular-errorhandler-template$$",f.put(e.templateUrl,e.template))}}])}(angular);