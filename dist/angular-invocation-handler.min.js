/* angular-invocation-handler - Version 1.2.1, 15-08-2015
 * 
 * Enables general error handling and logging which allows to log errors, e.g for automatically sending back to the backend or for showing to the user
 * 
 * Copyright 2015  - Martin Reinhardt <contact@martinreinhardt-online.de>
 * License MIT
 */
var core=angular.module("ngIH.core",[]),ui=angular.module("ngIH.ui",[]);core.constant("ngIHConfig",{model:{alerts:"alerts"},httpErrors:{0:"Der Server ist nicht erreichbar..",404:"Dieser Dienst existiert nicht.",405:"Zugriffsfehler.",500:"Unbekannte Serverfehler."},redirect:!1,customErrorHandler:!1,template:'<alert ng-repeat="alert in alerts" type="{{alert.type}}" close="alerts.splice($index, 1)">{{::alert.msg}}</alert>',feedbackAttach:!1}),core.provider("ngIHService",function(){"use strict";function a(a,b,c){return angular.extend(function(){var d=a.get("ngIHService");return d.call(c,b,arguments)},c)}var b=["$delegate","$injector",function(b,c){for(var d in b)angular.isFunction(b[d])&&(b[d]=a(c,b,b[d]));return b}];return{decorate:function(a,c){angular.forEach(c,function(c){a.decorator(c,b)})},$get:["$log","$injector","$window","$location","feedbackUI","ngIHConfig",function(a,b,c,d,e,f){var g={errors:[],resolveErrorCode:function(d,e,g){if(e){var h={error:{message:"An unknown error occurred.",data:e.data},timestamp:new Date,browserInfo:{navigatorAppName:navigator.appName,navigatorUserAgent:navigator.userAgent,navigatorPlatform:navigator.platform},location:angular.toJson(c.location),performance:c.performance?angular.toJson(c.performance):null};if(e&&!angular.isUndefined(e.status))h.status=e.status,f.customErrorHandler||(h.error.message=f.httpErrors[e.status0]);else if(e&&e.message){var i=e.message;h.error.exception=i.toString(),i.stack&&(h.error.stack=i.stack.toString())}d&&d.description&&(h.descripton="Call to "+d.description+" had caused errors."),a.error("An error occurred: "+h),f.customErrorHandler?b.get(f.customErrorHandler).resolve(h,g):g(h)}},funcError:function(b,c){g.resolveErrorCode(b,c,function(b){f.feedbackAttach&&e.appendErrorMsg(b),g.errors.push(b),f.redirect&&(a.info("Redirect to /"+c.status+".html"),d.path("/"+c.status+".html"))})},call:function(b,c,d){a.debug("Function called: ",b.name||b);var e;try{e=b.apply(c,d)}catch(f){throw g.funcError(b,f),f}var h=e&&e.$promise||e;return h&&angular.isFunction(h.then)&&angular.isFunction(h["catch"])&&g.async(b,h),e},async:function(a,b){return b["catch"](function(b){g.funcError(a,b)}),b}};return g}]}}),core.factory("httpErrorInterceptor",function(){"use strict";return{request:function(a){return a.timeout=3e3,a}}}),core.config(["$provide","$httpProvider",function(a,b){"use strict";b.interceptors.push("httpErrorInterceptor"),a.decorator("$exceptionHandler",["$delegate",function(a){return function(b,c){a(b,c)}}])}]),ui.factory("feedbackUI",["ngIHConfig","$timeout","$rootScope",function(a,b,c){"use strict";return{appendErrorMsg:function(b){c[a.model.alerts]||(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"danger",msg:b})},appendInfoMsg:function(b){c[a.model.alerts]||(c[a.model.alerts]=[]),c[a.model.alerts].push({type:"info",msg:b})}}}]),ui.directive("uiErrorHandler",["$rootScope","ngIHConfig",function(a,b){"use strict";return{restrict:"A",compile:function(a){a.append(b.template)}}}]),ui.run(["$rootScope","$document","ngIHConfig","$templateCache",function(a,b,c,d){"use strict";a.$on("$routeChangeStart",function(){a[c.model.alerts]=[]}),b.find(".header").attr("ui-error-handler",""),c.template&&(c.templateUrl="$$angular-errorhandler-template$$",d.put(c.templateUrl,c.template))}]);